<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SCTrack.tracker &mdash; SC-Track 0.0.1 alpha documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            SC-Track
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">README</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html">What’s  SC-Track?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#why-using-sc-track">Why using  SC-Track?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#how-to-use-sc-track">How to use SC-Track?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#installation">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../readme_link.html#usage">Usage</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">SC-Track</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">SCTrack.tracker</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for SCTrack.tracker</h1><div class="highlight"><pre>
<span></span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">import</span> <span class="nn">shapely</span>


<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;..&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span><span class="p">,</span> <span class="n">lru_cache</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">tifffile</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="kn">import</span> <span class="nn">treelib</span>
<span class="kn">from</span> <span class="nn">treelib</span> <span class="kn">import</span> <span class="n">Tree</span><span class="p">,</span> <span class="n">Node</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">SCTrack.utils</span> <span class="kn">import</span> <span class="n">convert_dtype</span><span class="p">,</span> <span class="n">readTif</span>
<span class="kn">from</span> <span class="nn">SCTrack.base</span> <span class="kn">import</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">Rectangle</span><span class="p">,</span> <span class="n">Vector</span><span class="p">,</span> <span class="n">TreeStatus</span><span class="p">,</span> <span class="n">CellStatus</span>
<span class="kn">from</span> <span class="nn">SCTrack.t_error</span> <span class="kn">import</span> <span class="n">InsertError</span><span class="p">,</span> <span class="n">MitosisError</span><span class="p">,</span> <span class="n">NodeExistError</span><span class="p">,</span> <span class="n">ErrorMatchMitosis</span><span class="p">,</span> <span class="n">StatusError</span>
<span class="kn">from</span> <span class="nn">SCTrack.feature</span> <span class="kn">import</span> <span class="n">FeatureExtractor</span><span class="p">,</span> <span class="n">feature_extract</span>
<span class="kn">from</span> <span class="nn">SCTrack</span> <span class="kn">import</span> <span class="n">config</span>


<span class="n">TEST</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">TEST_INDEX</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">CELL_NUM</span> <span class="o">=</span> <span class="mi">0</span>


<div class="viewcode-block" id="Checker"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Checker">[docs]</a><span class="k">class</span> <span class="nc">Checker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A checker that checks whether the cells participating in the match can calculate.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_protocols</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;calcIoU&#39;</span><span class="p">,</span> <span class="s1">&#39;calcCosDistance&#39;</span><span class="p">,</span> <span class="s1">&#39;calcCosSimilar&#39;</span><span class="p">,</span> <span class="s1">&#39;calcEuclideanDistance&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;compareDicSimilar&#39;</span><span class="p">,</span> <span class="s1">&#39;compareMcySimilar&#39;</span><span class="p">,</span> <span class="s1">&#39;compareShapeSimilar&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">protocol</span>

<div class="viewcode-block" id="Checker.check"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Checker.check">[docs]</a>    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Don&#39;t support protocol: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="si">}</span><span class="s2">, now just support </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_protocol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_protocol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;args[0]: object of func; args[1]: param 1 of func method; args[2]: param 2 of func method&quot;&quot;&quot;</span>
            <span class="c1"># print(_protocol)</span>
            <span class="c1"># print(&#39;args:&#39;, *args)</span>
            <span class="k">if</span> <span class="n">_protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_protocol</span> <span class="o">==</span> <span class="s1">&#39;calcIoU&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_protocol</span> <span class="o">==</span> <span class="s1">&#39;calcCosDistance&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_protocol</span> <span class="o">==</span> <span class="s1">&#39;calcCosSimilar&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_protocol</span> <span class="o">==</span> <span class="s1">&#39;compareDicSimilar&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_protocol</span> <span class="o">==</span> <span class="s1">&#39;compareMcySimilar&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_protocol</span> <span class="o">==</span> <span class="s1">&#39;compareShapeSimilar&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapper</span></div>


<div class="viewcode-block" id="CellNode"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode">[docs]</a><span class="k">class</span> <span class="nc">CellNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tracking node, including the track_ID, cell_id, branch_id of the cell, and the detailed information of the cell,</span>
<span class="sd">    the parent-child node relationship</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_instance_</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">STATUS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ACCURATE&#39;</span><span class="p">,</span> <span class="s1">&#39;ACCURATE-FL&#39;</span><span class="p">,</span> <span class="s1">&#39;INACCURATE&#39;</span><span class="p">,</span> <span class="s1">&#39;INACCURATE-MATCH&#39;</span><span class="p">,</span> <span class="s1">&#39;PREDICTED&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">track_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">__branch_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">childs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">add_tree</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># 如果被添加到TrackingTree中，设置为True</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">life</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># 每个分支初始生命值为5，如果没有匹配上，或者利用缺省值填充匹配，则-1，如如果生命值为0，则该分支不再参与匹配</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">_init_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instance_</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">node_type</span><span class="o">=</span><span class="s1">&#39;cell&#39;</span><span class="p">,</span> <span class="n">fill_gap_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_flag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cell</span> <span class="o">=</span> <span class="n">cell</span>
            <span class="k">if</span> <span class="n">node_type</span> <span class="o">==</span> <span class="s1">&#39;gap&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">fill_gap_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_flag</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The unique ID of a node within the scope of a TrackingTree&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;same as identifier, override treelib related methods&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span>

    <span class="k">def</span> <span class="nf">_set_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nid</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_identifier</span> <span class="o">=</span> <span class="n">nid</span>

<div class="viewcode-block" id="CellNode.get_status"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.get_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span></div>

<div class="viewcode-block" id="CellNode.set_parent"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.set_parent">[docs]</a>    <span class="k">def</span> <span class="nf">set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">CellNode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span></div>

<div class="viewcode-block" id="CellNode.get_parent"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.get_parent">[docs]</a>    <span class="k">def</span> <span class="nf">get_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span></div>

<div class="viewcode-block" id="CellNode.set_children"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.set_children">[docs]</a>    <span class="k">def</span> <span class="nf">set_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">CellNode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">childs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span></div>

<div class="viewcode-block" id="CellNode.get_children"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.get_children">[docs]</a>    <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">childs</span></div>

<div class="viewcode-block" id="CellNode.set_tree_status"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.set_tree_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_tree_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="n">TreeStatus</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_tree</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="CellNode.get_tree_status"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.get_tree_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_tree_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_tree</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_status</span>
        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="CellNode.set_status"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">status</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">STATUS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;set error status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CellNode.get_branch_id"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.get_branch_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_branch_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__branch_id</span></div>

<div class="viewcode-block" id="CellNode.set_branch_id"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.set_branch_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_branch_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">branch_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__branch_id</span> <span class="o">=</span> <span class="n">branch_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">set_branch_id</span><span class="p">(</span><span class="n">branch_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="CellNode.get_track_id"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.get_track_id">[docs]</a>    <span class="k">def</span> <span class="nf">get_track_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Don&#39;t set the track_id&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">track_id</span></div>

<div class="viewcode-block" id="CellNode.set_track_id"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.CellNode.set_track_id">[docs]</a>    <span class="k">def</span> <span class="nf">set_track_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track_id</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_id</span> <span class="o">=</span> <span class="n">track_id</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_tree</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Cell Node of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="si">}</span><span class="s2">, status: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tree_status</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Cell Node of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__repr__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>


<div class="viewcode-block" id="TrackingTree"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.TrackingTree">[docs]</a><span class="k">class</span> <span class="nc">TrackingTree</span><span class="p">(</span><span class="n">Tree</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The core structure of tracking implement. All tracking results are stored in the instance of this class.</span>
<span class="sd">    Each TrackingTree instance represents the cell line of a cell, and the TrackingTree branch represents cell division.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">:</span> <span class="n">CellNode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">track_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track_id</span> <span class="o">=</span> <span class="n">track_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mitosis_start_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">TreeStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__last_layer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exist_branch_id</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_branch_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_counter</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">identifier</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>

<div class="viewcode-block" id="TrackingTree.change_mitosis_flag"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.TrackingTree.change_mitosis_flag">[docs]</a>    <span class="k">def</span> <span class="nf">change_mitosis_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When the cell enters mitosis for the first time, self.mitosis_start_flag is set to True,</span>
<span class="sd">        and when the cell completes division, it is reset to false</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mitosis_start_flag</span> <span class="o">=</span> <span class="n">flag</span></div>

<div class="viewcode-block" id="TrackingTree.add_node"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.TrackingTree.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">CellNode</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">CellNode</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new CellNode object to the TrackingTree&quot;&quot;&quot;</span>
        <span class="n">node</span><span class="o">.</span><span class="n">set_parent</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">childs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span></div>

<div class="viewcode-block" id="TrackingTree.get_parent"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.TrackingTree.get_parent">[docs]</a>    <span class="k">def</span> <span class="nf">get_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">CellNode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the parent CellNode of a node&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">get_parent</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackingTree.get_childs"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.TrackingTree.get_childs">[docs]</a>    <span class="k">def</span> <span class="nf">get_childs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">CellNode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the child CellNode of a node&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all CellNodes in the last layer of TrackingTree&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last_layer</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_layer_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a dict of {leaf node: cells contained in the node}.&quot;&quot;&quot;</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaves</span><span class="p">():</span>
            <span class="n">cells</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>
        <span class="k">return</span> <span class="n">cells</span>

<div class="viewcode-block" id="TrackingTree.update_last_layer"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.TrackingTree.update_last_layer">[docs]</a>    <span class="k">def</span> <span class="nf">update_last_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">CellNode</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__last_layer</span> <span class="o">=</span> <span class="n">node_list</span></div>

<div class="viewcode-block" id="TrackingTree.auto_update_last_layer"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.TrackingTree.auto_update_last_layer">[docs]</a>    <span class="k">def</span> <span class="nf">auto_update_last_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__last_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaves</span><span class="p">()</span></div>

<div class="viewcode-block" id="TrackingTree.branch_id_distributor"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.TrackingTree.branch_id_distributor">[docs]</a>    <span class="k">def</span> <span class="nf">branch_id_distributor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used to assign a branch_id to each branch in a TrackingTree object.</span>
<span class="sd">        The branch_id is incremented in a non-reversible and non-reusable manner.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_branch_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exist_branch_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exist_branch_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_available_branch_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_available_branch_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_branch_id</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_branch_id</span> <span class="o">+</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exist_branch_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_available_branch_id</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_branch_id</span> <span class="o">+</span> <span class="n">i</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div></div>


<div class="viewcode-block" id="Match"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match">[docs]</a><span class="k">class</span> <span class="nc">Match</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Matcher, matches targets based on previous and next frames and assigns IDs in the current frame.</span>
<span class="sd">    Mainly used for feature matching and calculating similarity.</span>
<span class="sd">    The unit of operation is frames.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_instances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_instances</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

<div class="viewcode-block" id="Match.normalize"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.normalize">[docs]</a>    <span class="k">def</span> <span class="nf">normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Transforming the value to the range of [0, π/2].&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">x</span></div>

<div class="viewcode-block" id="Match.calcIoU_roughly"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.calcIoU_roughly">[docs]</a>    <span class="k">def</span> <span class="nf">calcIoU_roughly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate IoU of two cell bounding boxes.</span>
<span class="sd">        return value range: float(0-1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rect1</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="o">*</span><span class="n">cell_1</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>
        <span class="n">rect2</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="o">*</span><span class="n">cell_2</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rect1</span><span class="o">.</span><span class="n">isIntersect</span><span class="p">(</span><span class="n">rect2</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">rect1</span><span class="o">.</span><span class="n">isInclude</span><span class="p">(</span><span class="n">rect2</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intersection</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">rect1</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="n">rect2</span><span class="o">.</span><span class="n">x_min</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">rect1</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span> <span class="n">rect2</span><span class="o">.</span><span class="n">x_max</span><span class="p">),</span>
                                     <span class="nb">min</span><span class="p">(</span><span class="n">rect1</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="n">rect2</span><span class="o">.</span><span class="n">y_min</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">rect1</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span> <span class="n">rect2</span><span class="o">.</span><span class="n">y_max</span><span class="p">))</span>
            <span class="n">union</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">rect1</span><span class="o">.</span><span class="n">x_min</span><span class="p">,</span> <span class="n">rect2</span><span class="o">.</span><span class="n">x_min</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">rect1</span><span class="o">.</span><span class="n">x_max</span><span class="p">,</span> <span class="n">rect2</span><span class="o">.</span><span class="n">x_max</span><span class="p">),</span>
                              <span class="nb">max</span><span class="p">(</span><span class="n">rect1</span><span class="o">.</span><span class="n">y_min</span><span class="p">,</span> <span class="n">rect2</span><span class="o">.</span><span class="n">y_min</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">rect1</span><span class="o">.</span><span class="n">y_max</span><span class="p">,</span> <span class="n">rect2</span><span class="o">.</span><span class="n">y_max</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">union</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">intersection</span><span class="o">.</span><span class="n">area</span></div>

<div class="viewcode-block" id="Match.calcIoU"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.calcIoU">[docs]</a>    <span class="k">def</span> <span class="nf">calcIoU</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate IoU of two cells.</span>
<span class="sd">        return value range: float(0-1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">poly1</span> <span class="o">=</span> <span class="n">cell_1</span><span class="o">.</span><span class="n">polygon</span>
        <span class="n">poly2</span> <span class="o">=</span> <span class="n">cell_2</span><span class="o">.</span><span class="n">polygon</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
                <span class="n">intersection</span> <span class="o">=</span> <span class="n">poly1</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">poly2</span><span class="p">)</span>
                <span class="n">union</span> <span class="o">=</span> <span class="n">poly1</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">poly2</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">shapely</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">GEOSException</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">calcIoU_roughly</span><span class="p">(</span><span class="n">cell_1</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">union</span><span class="o">.</span><span class="n">area</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">poly1</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">poly2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">poly2</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">poly1</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">intersection</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">union</span><span class="o">.</span><span class="n">area</span></div>

<div class="viewcode-block" id="Match.calcCosDistance"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.calcCosDistance">[docs]</a>    <span class="k">def</span> <span class="nf">calcCosDistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the cosine distance of two cells</span>
<span class="sd">        Return value range: float[0, 2]</span>
<span class="sd">        The smaller the distance, the more similar it is, scaled to [0, 1) by the arctangent function</span>
<span class="sd">        The return value is the cosine value after normalization [0, π/2]. The smaller the return value, the lower the similarity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">cell_1</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">cosDistance</span><span class="p">(</span><span class="n">cell_2</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span></div>

<div class="viewcode-block" id="Match.calcCosSimilar"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.calcCosSimilar">[docs]</a>    <span class="k">def</span> <span class="nf">calcCosSimilar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the cosine similarity of the center points of two cells</span>
<span class="sd">        Return value range: float[0, 1]</span>
<span class="sd">        The larger the value, the more similar</span>
<span class="sd">        The return value is the sine value after normalization [0, π/2]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">cell_1</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">cosSimilar</span><span class="p">(</span><span class="n">cell_2</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">score</span><span class="p">))</span></div>

<div class="viewcode-block" id="Match.calcAreaSimilar"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.calcAreaSimilar">[docs]</a>    <span class="k">def</span> <span class="nf">calcAreaSimilar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the area similarity of two cells</span>
<span class="sd">        Return value range: float[0, 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">cell_1</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">cell_2</span><span class="o">.</span><span class="n">area</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">cell_1</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">cell_2</span><span class="o">.</span><span class="n">area</span><span class="p">)</span></div>

<div class="viewcode-block" id="Match.calcEuclideanDistance"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.calcEuclideanDistance">[docs]</a>    <span class="k">def</span> <span class="nf">calcEuclideanDistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Euclidean distance between two cell center points</span>
<span class="sd">        Return value range: float(0,∞)</span>
<span class="sd">        The smaller the distance, the more similar it is, scaled to [0, 1) by the arctangent function</span>
<span class="sd">        The return value is the cosine value after normalization [0, π/2]. The smaller the return value, the lower the similarity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">cell_1</span><span class="o">.</span><span class="n">vector</span><span class="o">.</span><span class="n">EuclideanDistance</span><span class="p">(</span><span class="n">cell_2</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
        <span class="c1"># return np.cos(np.arctan(dist) / (np.pi / 2))</span>
        <span class="k">return</span> <span class="n">dist</span></div>

<div class="viewcode-block" id="Match.compareDicSimilar"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.compareDicSimilar">[docs]</a>    <span class="k">def</span> <span class="nf">compareDicSimilar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare dic similarity</span>
<span class="sd">        Return value range: float(0, 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dic1</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">cell_1</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">dic_intensity</span><span class="p">,</span> <span class="n">cell_1</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">dic_variance</span><span class="p">)</span>
        <span class="n">dic2</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">cell_2</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">dic_intensity</span><span class="p">,</span> <span class="n">cell_2</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">dic_variance</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dic1</span> <span class="ow">and</span> <span class="n">dic2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">dic1</span><span class="o">.</span><span class="n">cosSimilar</span><span class="p">(</span><span class="n">dic2</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Match.compareMcySimilar"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.compareMcySimilar">[docs]</a>    <span class="k">def</span> <span class="nf">compareMcySimilar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare mcy similarity</span>
<span class="sd">        Return value range: float(0, 1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mcy1</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">cell_1</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mcy_intensity</span><span class="p">,</span> <span class="n">cell_1</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mcy_variance</span><span class="p">)</span>
        <span class="n">mcy2</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">cell_2</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mcy_intensity</span><span class="p">,</span> <span class="n">cell_2</span><span class="o">.</span><span class="n">feature</span><span class="o">.</span><span class="n">mcy_variance</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mcy1</span> <span class="ow">and</span> <span class="n">mcy2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">mcy1</span><span class="o">.</span><span class="n">cosSimilar</span><span class="p">(</span><span class="n">mcy2</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Match.compareShapeSimilar"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Match.compareShapeSimilar">[docs]</a>    <span class="k">def</span> <span class="nf">compareShapeSimilar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the contour similarity of two cells</span>
<span class="sd">        Return value range: float(0, 1)</span>
<span class="sd">        The smaller the score value, the greater the similarity, and the inversion operation can be performed</span>
<span class="sd">        The return value is the cosine value after normalization [0, π/2]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchShapes</span><span class="p">(</span><span class="n">cell_1</span><span class="o">.</span><span class="n">contours</span><span class="p">,</span> <span class="n">cell_2</span><span class="o">.</span><span class="n">contours</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="c1"># return np.cos(self.normalize(score))</span>
        <span class="k">return</span> <span class="n">score</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Match object at </span><span class="si">{</span><span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span></div>


<div class="viewcode-block" id="Matcher"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher">[docs]</a><span class="k">class</span> <span class="nc">Matcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A matcher that realizes the association of front and back frame objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">Match</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">WEIGHT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IoU&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">}</span>

<div class="viewcode-block" id="Matcher.draw_bbox"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.draw_bbox">[docs]</a>    <span class="k">def</span> <span class="nf">draw_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bg1</span><span class="p">,</span> <span class="n">bbox</span><span class="p">,</span> <span class="n">track_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bg1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">im_rgb1</span> <span class="o">=</span> <span class="n">bg1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im_rgb1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">convert_dtype</span><span class="p">(</span><span class="n">bg1</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2RGB</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">im_rgb1</span><span class="p">,</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                      <span class="p">[</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_rgb1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">track_id</span><span class="p">),</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_COMPLEX</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">im_rgb1</span></div>

<div class="viewcode-block" id="Matcher.predict_next_position"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.predict_next_position">[docs]</a>    <span class="k">def</span> <span class="nf">predict_next_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        According to the speed, the possible position of the daughter cell is predicted, and the predicted daughter cell</span>
<span class="sd">        is used to participate in the matching. speed=0 is equivalent to not enabling prediction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># new_cell = parent.move(parent.move_speed, 1)</span>
        <span class="n">new_cell</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="k">return</span> <span class="n">new_cell</span></div>

    <span class="k">def</span> <span class="nf">_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cells</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Cell</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;filter candidates&quot;&quot;&quot;</span>

        <span class="c1"># filtered_candidates = [cell for cell in cells if cell in child]</span>
        <span class="n">filtered_candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">child</span> <span class="ow">and</span> <span class="n">cell</span><span class="o">.</span><span class="n">is_accurate_matched</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcEuclideanDistance</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">child</span><span class="o">.</span><span class="n">r_long</span> <span class="ow">or</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcIoU</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">:</span>
                    <span class="n">filtered_candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_candidates</span>

<div class="viewcode-block" id="Matcher.match_candidates"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.match_candidates">[docs]</a>    <span class="k">def</span> <span class="nf">match_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">before_cell_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Cell</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;match candidates&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">before_cell_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="Matcher.calc_similar"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.calc_similar">[docs]</a>    <span class="k">def</span> <span class="nf">calc_similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the similarity of two cells&quot;&quot;&quot;</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcIoU</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcAreaSimilar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">compareShapeSimilar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcEuclideanDistance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcCosDistance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcCosSimilar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">compareDicSimilar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">compareMcySimilar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child_cell</span><span class="p">)]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">floatmode</span><span class="o">=</span><span class="s1">&#39;fixed&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">similar</span><span class="p">)</span></div>

<div class="viewcode-block" id="Matcher.match_similar"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.match_similar">[docs]</a>    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">match_similar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_1</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the similarity of two cells, do not include the image information.&quot;&quot;&quot;</span>
        <span class="n">similar</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;IoU&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcIoU</span><span class="p">(</span><span class="n">cell_1</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">),</span>
                   <span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">compareShapeSimilar</span><span class="p">(</span><span class="n">cell_1</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">),</span>
                   <span class="s1">&#39;area&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcAreaSimilar</span><span class="p">(</span><span class="n">cell_1</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">),</span>
                   <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcEuclideanDistance</span><span class="p">(</span><span class="n">cell_1</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">)</span>
                   <span class="p">}</span>
        <span class="k">return</span> <span class="n">similar</span></div>

<div class="viewcode-block" id="Matcher.match_duplicate_child"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.match_duplicate_child">[docs]</a>    <span class="k">def</span> <span class="nf">match_duplicate_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">unmatched_child_list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Match multiple candidates. Calling this function means that there is more than one candidate, and this method</span>
<span class="sd">        calculates the matching degree of each candidate</span>
<span class="sd">        The return value is a dictionary in the form of {Cell: similar_dict}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unmatched_child_list</span><span class="p">:</span>
            <span class="c1"># if i.is_be_matched :</span>
            <span class="c1">#     if i.status.exist_mitosis_time &lt; 50:</span>
            <span class="c1">#         continue</span>
            <span class="n">similar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">matched</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">similar</span>
        <span class="k">return</span> <span class="n">matched</span></div>

<div class="viewcode-block" id="Matcher.is_mitosis_start"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.is_mitosis_start">[docs]</a>    <span class="k">def</span> <span class="nf">is_mitosis_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_parent</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">last_leaves</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Cell</span><span class="p">],</span> <span class="n">area_size_t</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">iou_t</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine whether a cell enters the M phase. The basic criterion is that when a cell enters mitosis, its volume</span>
<span class="sd">        increases and the number of candidate regions increases. If the cell successfully enters the M phase, return a</span>
<span class="sd">        dict containing information about the last frame of G2 and the first frame of M. Otherwise, return False.</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="n">match_score</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">last_leaves</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">pre_parent</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IoU&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">iou_t</span><span class="p">:</span>
                <span class="n">match_score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">pre_parent</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child_cell</span> <span class="ow">in</span> <span class="n">match_score</span><span class="p">:</span>
            <span class="c1"># if Rectangle(*parent.bbox).isInclude(Rectangle(*child_cell.bbox)) or (</span>
            <span class="c1">#         (child_cell.area / parent.area) &gt;= area_size_t):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">child_cell</span><span class="o">.</span><span class="n">area</span> <span class="o">/</span> <span class="n">pre_parent</span><span class="o">.</span><span class="n">area</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">area_size_t</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;last_G2&#39;</span><span class="p">:</span> <span class="n">pre_parent</span><span class="p">,</span> <span class="s1">&#39;first_M&#39;</span><span class="p">:</span> <span class="n">child_cell</span><span class="p">}</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Matcher.get_similar_sister"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.get_similar_sister">[docs]</a>    <span class="k">def</span> <span class="nf">get_similar_sister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">matched_cells_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">area_t</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">shape_t</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">area_size_t</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span>
                           <span class="n">iou_t</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the two most similar cells among multiple candidates as the daughter cells.&quot;&quot;&quot;</span>
        <span class="n">cell_dict_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matched_cells_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">cell_dict_keys</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">area</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cell_dict_keys</span><span class="p">:</span>
            <span class="c1"># if matched_cells_dict[cell].get(&#39;IoU&#39;) &lt; iou_t:</span>
            <span class="k">if</span> <span class="n">matched_cells_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IoU&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cell_dict_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="c1"># if len(cell_dict_keys) &gt; 2:</span>
        <span class="c1">#     if cell_dict_keys[0].area + cell_dict_keys[1].area &gt; parent.area * area_size_t:</span>
        <span class="c1">#         cell_dict_keys.remove(cell_dict_keys[0])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_dict_keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">remove_dict_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matched_cells_dict</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;IoU&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">remove_dict_list</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cell_dict_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_dict_keys</span><span class="p">)</span>
        <span class="n">match_result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">cell_1</span> <span class="o">=</span> <span class="n">cell_dict_keys</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_dict_keys</span><span class="p">)):</span>
                <span class="n">cell_2</span> <span class="o">=</span> <span class="n">cell_dict_keys</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">cell_1</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">)</span>
                <span class="c1"># if score.get(&#39;area&#39;) &gt;= area_t and score.get(&#39;shape&#39;) &lt;= shape_t:</span>
                <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">area_t</span><span class="p">:</span>
                    <span class="n">match_result</span><span class="p">[(</span><span class="n">cell_1</span><span class="p">,</span> <span class="n">cell_2</span><span class="p">)]</span> <span class="o">=</span> <span class="n">score</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">score</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IoU&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match_result</span><span class="p">:</span>
            <span class="n">max_score_cells</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">match_result</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">match_result</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">max_score_cells</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MitosisError</span><span class="p">(</span><span class="s1">&#39;cannot match the suitable daughter cells&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Matcher.select_mitosis_cells"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.select_mitosis_cells">[docs]</a>    <span class="k">def</span> <span class="nf">select_mitosis_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">candidates_child_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Cell</span><span class="p">],</span> <span class="n">area_t</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">shape_t</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                             <span class="n">area_size_t</span><span class="o">=</span><span class="mf">1.3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If cell division occurs, select two daughter cells. When calling this method, make sure that cell division is</span>
<span class="sd">        highly likely to occur. If the return value is cell division, then it is necessary to check whether the areas</span>
<span class="sd">        of the two daughter cells are normal. If the area of one daughter cell is too large, it is considered a FP.</span>

<span class="sd">        :return ([cell_1, cell2], &#39;match status&#39;)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">matched_candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_duplicate_child</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">candidates_child_list</span><span class="p">)</span>
        <span class="n">checked_candidates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">matched_candidates</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_be_matched</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">exist_mitosis_time</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">checked_candidates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">matched_candidates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">matched_cells_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_iou</span><span class="p">(</span><span class="n">checked_candidates</span><span class="p">)</span>
        <span class="c1"># matched_cells_dict = self.check_iou(matched_candidates)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matched_cells_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">MitosisError</span><span class="p">(</span><span class="s1">&#39;not enough candidates&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_cells_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">matched_cells_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
                <span class="c1"># if max([i.area for i in</span>
                <span class="c1">#         list(matched_cells_dict.keys())]) &gt; parent.area * area_size_t:  # 如果母细胞太小了，不认为会发生有丝分裂，转向单项判断</span>
                <span class="c1">#     raise MitosisError(&#39;The cell is too small to have cell division !&#39;)</span>
                <span class="c1"># if self.matcher.calcAreaSimilar(cells[0], cells[1]) &gt; area_t and self.matcher.compareShapeSimilar(</span>
                <span class="c1">#         cells[0], cells[1]) &lt; shape_t:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcAreaSimilar</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">area_t</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">cells</span><span class="p">,</span> <span class="s1">&#39;ACCURATE&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># raise MitosisError(&quot;not enough candidates, after matched.&quot;)</span>
                    <span class="k">return</span> <span class="n">cells</span><span class="p">,</span> <span class="s1">&#39;INACCURATE&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># max_two = heapq.nlargest(2, [sum(sm) for sm in matched_cells_dict.values()])  # 找到匹配结果中最大的两个值</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">max_two</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_similar_sister</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">matched_cells_dict</span><span class="p">)</span>  <span class="c1"># 找到匹配结果中最大的两个值</span>
                <span class="k">except</span> <span class="n">MitosisError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">MitosisError</span><span class="p">(</span><span class="s2">&quot;not enough candidates, after matched.&quot;</span><span class="p">)</span>
                <span class="n">better_sisters</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">max_two</span><span class="p">:</span>
                    <span class="n">better_sisters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">calcAreaSimilar</span><span class="p">(</span><span class="n">better_sisters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                <span class="n">better_sisters</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">area_t</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">compareShapeSimilar</span><span class="p">(</span>
                    <span class="n">better_sisters</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">better_sisters</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">shape_t</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">better_sisters</span><span class="p">,</span> <span class="s1">&#39;ACCURATE&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">better_sisters</span><span class="p">,</span> <span class="s1">&#39;INACCURATE&#39;</span></div>

<div class="viewcode-block" id="Matcher.select_single_child"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.select_single_child">[docs]</a>    <span class="k">def</span> <span class="nf">select_single_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For multiple IOU matching options, choose the one with a higher similarity. This is to distinguish overlapping</span>
<span class="sd">        cells rather than cell division. Note: the results of this method are not necessarily accurate and may result</span>
<span class="sd">        in mismatches due to cell crossing, which needs to be resolved in subsequent steps. In addition, if one cell is</span>
<span class="sd">        accurately matched, and the other cell has no match (i.e., not detected in the next frame during recognition),</span>
<span class="sd">        it should be filled as a predicted cell.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">calc_weight</span><span class="p">(</span><span class="n">candidate_score_dict</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Compute and dynamically update matching weights and matching results.&quot;&quot;&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># for cell in candidate_score_dict:</span>
            <span class="c1">#     score_dict = candidate_score_dict[cell]</span>
            <span class="c1"># value =  score_dict[&#39;IoU&#39;] * self.WEIGHT.get(&#39;IoU&#39;) + \</span>
            <span class="c1">#        score_dict[&#39;shape&#39;] * self.WEIGHT.get(&#39;shape&#39;) + score_dict[&#39;area&#39;] * self.WEIGHT.get(&#39;area&#39;)</span>
            <span class="n">selected_cell</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">max_iou</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">min_distance</span> <span class="o">=</span> <span class="mi">100</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">iou_above_threshold</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="n">score_dict</span> <span class="ow">in</span> <span class="n">candidate_score_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">iou</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="s1">&#39;IoU&#39;</span><span class="p">]</span>
                <span class="n">distance</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>

                <span class="c1"># If iou is greater than the threshold, update the maximum iou and the selected cell,</span>
                <span class="c1"># and set iou_above_threshold to True</span>
                <span class="k">if</span> <span class="n">iou</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">iou_above_threshold</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="n">min_distance</span><span class="p">:</span>
                        <span class="n">selected_cell</span> <span class="o">=</span> <span class="n">cell</span>
                        <span class="n">min_distance</span> <span class="o">=</span> <span class="n">distance</span>
                        <span class="n">max_iou</span> <span class="o">=</span> <span class="n">iou</span>

                <span class="c1"># If the iou is not greater than the threshold, but greater than the current maximum iou,</span>
                <span class="c1"># update the maximum iou and the selected cell</span>
                <span class="k">elif</span> <span class="n">iou</span> <span class="o">&gt;</span> <span class="n">max_iou</span><span class="p">:</span>
                    <span class="n">selected_cell</span> <span class="o">=</span> <span class="n">cell</span>
                    <span class="n">max_iou</span> <span class="o">=</span> <span class="n">iou</span>
                    <span class="n">min_distance</span> <span class="o">=</span> <span class="n">distance</span>

            <span class="c1"># If the iou is not greater than the threshold, but greater than the current maximum iou,</span>
            <span class="c1"># update the maximum iou and the selected cell</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">iou_above_threshold</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="n">score_dict</span> <span class="ow">in</span> <span class="n">candidate_score_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">iou</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="s1">&#39;IoU&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">iou</span> <span class="o">&gt;</span> <span class="n">max_iou</span><span class="p">:</span>
                        <span class="n">selected_cell</span> <span class="o">=</span> <span class="n">cell</span>
                        <span class="n">max_iou</span> <span class="o">=</span> <span class="n">iou</span>
            <span class="k">return</span> <span class="n">selected_cell</span>
            <span class="c1"># return max(result, key=result.get)</span>

        <span class="n">candidates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">score_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IoU&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">score_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IoU&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
                    <span class="n">candidates</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">score_dict</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IoU&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                    <span class="n">candidates</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">score_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">score_dict</span><span class="p">:</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">score_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">candidates</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">score_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">calc_weight</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best</span></div>

<div class="viewcode-block" id="Matcher.match_one"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.match_one">[docs]</a>    <span class="k">def</span> <span class="nf">match_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predict_child</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># print(&#39;matched single:&#39;, self.calc_similar(parent, filtered_candidates[0]))</span>
            <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_similar</span><span class="p">(</span><span class="n">predict_child</span><span class="p">,</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;ACCURATE&#39;</span><span class="p">)]</span>
            <span class="k">elif</span> <span class="n">score</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[(</span><span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;INACCURATE&#39;</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="Matcher.check_iou"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.check_iou">[docs]</a>    <span class="k">def</span> <span class="nf">check_iou</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">similar_dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the IoU to provide a basis for determining cell division. If there are less than 2 matching options</span>
<span class="sd">        with IoU &gt; 0, return False. Otherwise, return these two cells.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">similar_dict</span><span class="p">:</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">similar_dict</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">score</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;IoU&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">matched</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">matched</span></div>

    <span class="k">def</span> <span class="nf">_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">filter_candidates_cells</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Cell</span><span class="p">],</span> <span class="n">cell_track_status</span><span class="p">:</span> <span class="n">TreeStatus</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the overall similarity of two cells.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># predict_child = self.predict_next_position(parent)</span>
        <span class="n">predict_child</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="c1"># filtered_candidates = self.match_candidates(predict_child, no_filter_candidates_cells)</span>
        <span class="n">filtered_candidates</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">filter_candidates_cells</span> <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">is_accurate_matched</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">]</span>
        <span class="c1"># print(filtered_candidates)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_one</span><span class="p">(</span><span class="n">predict_child</span><span class="p">,</span> <span class="n">filtered_candidates</span><span class="p">):</span>  <span class="c1"># 不只有一个选项</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_one</span><span class="p">(</span><span class="n">predict_child</span><span class="p">,</span> <span class="n">filtered_candidates</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">matched_candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_duplicate_child</span><span class="p">(</span><span class="n">predict_child</span><span class="p">,</span> <span class="n">filtered_candidates</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">cell_track_status</span><span class="o">.</span><span class="n">enter_mitosis</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_track_status</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;enter_mitosis&#39;</span><span class="p">):</span>
                    <span class="c1"># if parent.phase != &#39;M&#39;:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;matched_cell&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">select_single_child</span><span class="p">(</span><span class="n">matched_candidates</span><span class="p">),</span> <span class="s1">&#39;INACCURATE&#39;</span><span class="p">)],</span>
                            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">cell_track_status</span><span class="p">}</span>
                <span class="c1"># elif not self.check_iou(matched_candidates):</span>
                <span class="c1">#     return {&#39;matched_cell&#39;: [(self.select_single_child(matched_candidates), &#39;ACCURATE&#39;)],</span>
                <span class="c1">#             &#39;status&#39;: cell_track_status}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">matched_result</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sisters</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_mitosis_cells</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">filtered_candidates</span><span class="p">)</span>  <span class="c1"># 此时细胞一分为二</span>
                        <span class="n">cell_track_status</span><span class="o">.</span><span class="n">exit_mitosis</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">sister</span> <span class="ow">in</span> <span class="n">sisters</span><span class="p">:</span>
                            <span class="n">matched_result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sister</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>

                    <span class="k">except</span> <span class="n">MitosisError</span> <span class="k">as</span> <span class="n">M</span><span class="p">:</span>  <span class="c1"># 细胞可能仍然处于M期，但是已经完成分开，或者只是被误判为M期</span>
                        <span class="n">matched_result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">select_single_child</span><span class="p">(</span><span class="n">matched_candidates</span><span class="p">),</span> <span class="s1">&#39;INACCURATE&#39;</span><span class="p">))</span>
                        <span class="c1"># print(M)</span>
                    <span class="k">except</span> <span class="n">ErrorMatchMitosis</span> <span class="k">as</span> <span class="n">M2</span><span class="p">:</span>
                        <span class="c1"># 细胞可能不均等分裂</span>
                        <span class="n">matched_result</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">select_single_child</span><span class="p">(</span><span class="n">matched_candidates</span><span class="p">),</span> <span class="s1">&#39;INACCURATE&#39;</span><span class="p">))</span>
                        <span class="c1"># print(M2)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;matched_cell&#39;</span><span class="p">:</span> <span class="n">matched_result</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">cell_track_status</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;matched_cell&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_one</span><span class="p">(</span><span class="n">predict_child</span><span class="p">,</span> <span class="n">filtered_candidates</span><span class="p">),</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">cell_track_status</span><span class="p">}</span>

<div class="viewcode-block" id="Matcher.calc_sorted_value"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.calc_sorted_value">[docs]</a>    <span class="k">def</span> <span class="nf">calc_sorted_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">matched_cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the sorting value of a Cell object.&quot;&quot;&quot;</span>

        <span class="n">match_score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">matched_cell</span><span class="p">)</span>
        <span class="n">sort_value</span> <span class="o">=</span> <span class="n">match_score</span><span class="p">[</span><span class="s1">&#39;IoU&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">match_score</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sort_value</span></div>

<div class="viewcode-block" id="Matcher.add_child_node"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.add_child_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_child_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">child_node</span><span class="p">:</span> <span class="n">CellNode</span><span class="p">,</span> <span class="n">parent_node</span><span class="p">:</span> <span class="n">CellNode</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">child_node</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent_node</span><span class="p">)</span>
            <span class="n">child_node</span><span class="o">.</span><span class="n">set_tree_status</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
        <span class="c1"># except TypeError as E:</span>
        <span class="c1">#     print(E)</span>
        <span class="c1"># except NodeExistError as E2:</span>
        <span class="c1">#     print(E2)</span>
        <span class="k">except</span> <span class="n">treelib</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">DuplicatedNodeIdError</span><span class="p">:</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="Matcher.match_single_cell"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Matcher.match_single_cell">[docs]</a>    <span class="k">def</span> <span class="nf">match_single_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">TrackingTree</span><span class="p">,</span> <span class="n">current_frame</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The implementation logic for tracking a single cell.&quot;&quot;&quot;</span>

        <span class="n">cells</span> <span class="o">=</span> <span class="n">current_frame</span><span class="o">.</span><span class="n">cells</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">last_layer_cell</span>
        <span class="n">m_counter</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">parent_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">parent</span><span class="p">:</span> <span class="n">parent</span><span class="o">.</span><span class="n">frame</span> <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">}</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">parent_dict</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">!=</span> <span class="n">parent_dict</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span>
                <span class="n">min_parent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">parent_dict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">parent_dict</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
                <span class="n">parents</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">min_parent</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="c1"># Two or more cells after cell division.</span>
            <span class="c1"># print(f&#39;\nparent cell math status: {parent.is_be_matched}&#39;)</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">m_counter</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">tree</span><span class="o">.</span><span class="n">m_counter</span><span class="p">:</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">m_counter</span> <span class="o">=</span> <span class="mi">5</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">reset_M_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="s1">&#39;M&#39;</span><span class="p">:</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">add_M_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">predict_M_len</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">enter_mitosis</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span>

            <span class="c1"># predict_child = self.predict_next_position(parent)</span>
            <span class="n">predict_child</span> <span class="o">=</span> <span class="n">parent</span>

            <span class="n">filtered_candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_candidates</span><span class="p">(</span><span class="n">predict_child</span><span class="p">,</span> <span class="n">cells</span><span class="p">)</span>
            <span class="c1"># filtered_candidates = list(candidates)</span>
            <span class="n">before_parent</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">get_parent</span><span class="p">(</span><span class="n">parents</span><span class="p">[</span><span class="n">parent</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">before_parent</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_mitosis_start</span><span class="p">(</span><span class="n">before_parent</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="p">[</span><span class="n">predict_child</span><span class="p">]):</span>
                    <span class="c1"># if self.is_mitosis_start(predict_child, filtered_candidates):</span>
                    <span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">enter_mitosis</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
            <span class="n">match_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match</span><span class="p">(</span><span class="n">predict_child</span><span class="p">,</span> <span class="n">filtered_candidates</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">child_cells</span> <span class="o">=</span> <span class="n">match_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;matched_cell&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">child_cells</span><span class="p">:</span>
                    <span class="n">sort_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_sorted_value</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sort_value</span> <span class="o">=</span> <span class="n">sort_value</span>
                <span class="n">parent_node</span> <span class="o">=</span> <span class="n">CellNode</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">child_cells</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># if child_cells[0][1] == &#39;PREDICTED&#39;:</span>
                <span class="c1">#     current_frame.add_cell(child_cells[0][0])</span>
                <span class="c1">#     child_node = CellNode(child_cells[0][0])</span>
                <span class="c1">#     child_node.life -= 1</span>
                <span class="k">if</span> <span class="n">child_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ACCURATE&#39;</span><span class="p">:</span>
                    <span class="c1"># candidates.remove(child_cells[0][0])</span>
                    <span class="n">child_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_accurate_matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">child_node</span> <span class="o">=</span> <span class="n">CellNode</span><span class="p">(</span><span class="n">child_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">child_node</span> <span class="o">=</span> <span class="n">CellNode</span><span class="p">(</span><span class="n">child_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1"># child_cells[0][0].is_accurate_matched = True</span>
                <span class="c1"># child_node.set_branch_id(parent_node.get_branch_id())</span>
                <span class="n">child_node</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">set_branch_id</span><span class="p">(</span><span class="n">parent_node</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">branch_id</span><span class="p">)</span>
                <span class="n">child_node</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                <span class="n">child_node</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">update_region</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span>
                <span class="n">child_node</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">update_region</span><span class="p">(</span><span class="n">branch_id</span><span class="o">=</span><span class="n">parent_node</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">branch_id</span><span class="p">)</span>
                <span class="n">child_node</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">set_match_status</span><span class="p">(</span><span class="n">child_cells</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># if child_node.life &gt; 0:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_child_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">child_node</span><span class="p">,</span> <span class="n">parent_node</span><span class="p">)</span>
                <span class="c1"># child_node.branch_id = parent_node.branch_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#     try:</span>
                <span class="c1">#         assert len(child_cells) == 2</span>
                <span class="c1">#     except AssertionError:</span>
                <span class="c1">#         # self._match(predict_child, filtered_candidates, tree.status)</span>
                <span class="c1">#         continue</span>

                <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">child_cells</span><span class="p">:</span>
                    <span class="n">new_branch_id</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">branch_id_distributor</span><span class="p">()</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_branch_id</span><span class="p">(</span><span class="n">new_branch_id</span><span class="p">)</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update_region</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">update_region</span><span class="p">(</span><span class="n">branch_id</span><span class="o">=</span><span class="n">new_branch_id</span><span class="p">)</span>
                    <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_match_status</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">child_node</span> <span class="o">=</span> <span class="n">CellNode</span><span class="p">(</span><span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ACCURATE&#39;</span><span class="p">:</span>
                        <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_accurate_matched</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># candidates.remove(cell[0])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_child_node</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">child_node</span><span class="p">,</span> <span class="n">parent_node</span><span class="p">)</span>
        <span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">add_exist_time</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="Tracker"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker">[docs]</a><span class="k">class</span> <span class="nc">Tracker</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tracker object, which is the controller of the tracking process. It reads images frame by frame,</span>
<span class="sd">    initializes and updates the TrackingTree, performs matching and assigns various IDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">mcy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dic</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">Matcher</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe_cache</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TrackingTree</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mcy</span> <span class="o">=</span> <span class="n">mcy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dic</span> <span class="o">=</span> <span class="n">dic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span> <span class="o">=</span> <span class="n">annotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exist_tree_id</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_ext</span> <span class="o">=</span> <span class="n">feature_extract</span><span class="p">(</span><span class="n">mcy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mcy</span><span class="p">,</span> <span class="n">dic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dic</span><span class="p">,</span> <span class="n">jsonfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree_maps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_tracking_tree</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_ext</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser_dict</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Tracker.id_distributor"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.id_distributor">[docs]</a>    <span class="k">def</span> <span class="nf">id_distributor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exist_tree_id</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exist_tree_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_available_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_available_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_id</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_id</span> <span class="o">+</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exist_tree_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_available_id</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_available_id</span> <span class="o">+</span> <span class="n">i</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Tracker.init_tracking_tree"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.init_tracking_tree">[docs]</a>    <span class="k">def</span> <span class="nf">init_tracking_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize TrackingTree&quot;&quot;&quot;</span>
        <span class="c1"># trees = []</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fe</span><span class="o">.</span><span class="n">cells</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">TrackingTree</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_distributor</span><span class="p">())</span>
            <span class="n">i</span><span class="o">.</span><span class="n">sort_value</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">i</span><span class="o">.</span><span class="n">set_match_status</span><span class="p">(</span><span class="s1">&#39;ACCURATE&#39;</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">set_track_id</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">set_branch_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">set_cell_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">branch_id</span><span class="p">))</span>
            <span class="n">i</span><span class="o">.</span><span class="n">update_region</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">update_region</span><span class="p">(</span><span class="n">branch_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">node</span> <span class="o">=</span> <span class="n">CellNode</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">set_branch_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">set_track_id</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span>
            <span class="n">node</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ACCURATE&#39;</span>
            <span class="n">i</span><span class="o">.</span><span class="n">set_match_status</span><span class="p">(</span><span class="s1">&#39;ACCURATE&#39;</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">is_accurate_matched</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">node</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">TreeStatus</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree_maps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_flag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># self.trees = trees</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fe</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracker.draw_bbox"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.draw_bbox">[docs]</a>    <span class="k">def</span> <span class="nf">draw_bbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bg1</span><span class="p">,</span> <span class="n">cell</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">track_id</span><span class="p">,</span> <span class="n">branch_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phase</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bbox</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">bbox</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bg1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">im_rgb1</span> <span class="o">=</span> <span class="n">bg1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im_rgb1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">convert_dtype</span><span class="p">(</span><span class="n">bg1</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_GRAY2RGB</span><span class="p">)</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span><span class="n">im_rgb1</span><span class="p">,</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                      <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_str</span><span class="p">():</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">track_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">branch_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span>
                <span class="n">raw</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">branch_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">raw</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span>
                <span class="n">raw</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">phase</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">raw</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">get_str</span><span class="p">()</span>
        <span class="n">cv2</span><span class="o">.</span><span class="n">putText</span><span class="p">(</span><span class="n">im_rgb1</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="n">bbox</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">bbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">FONT_HERSHEY_TRIPLEX</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">im_rgb1</span></div>

<div class="viewcode-block" id="Tracker.update_speed"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.update_speed">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">update_speed</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">Cell</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Vector</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update cell movement speed&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">default</span><span class="p">:</span>
            <span class="n">child</span><span class="o">.</span><span class="n">update_speed</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">vector</span> <span class="o">-</span> <span class="n">parent</span><span class="o">.</span><span class="n">vector</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">update_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracker.get_current_tree"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.get_current_tree">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_cell</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the TrackingTree where the current parent cell is located&quot;&quot;&quot;</span>
        <span class="n">exist_trees</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># 细胞可能存在的tree</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parent_cell</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">last_layer_cell</span><span class="p">:</span>
                <span class="n">exist_trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exist_trees</span></div>

<div class="viewcode-block" id="Tracker.add_node"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child_node</span><span class="p">,</span> <span class="n">parent_node</span><span class="p">,</span> <span class="n">tree</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">child_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tree</span><span class="p">:</span>
            <span class="c1"># tree.add_node(child_node, parent=parent_node.identifier)</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">child_node</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent_node</span><span class="p">)</span>
            <span class="n">child_node</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">CellStatus</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NodeExistError</span><span class="p">(</span><span class="n">child_node</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracker.track_near_frame"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.track_near_frame">[docs]</a>    <span class="k">def</span> <span class="nf">track_near_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe1</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">,</span> <span class="n">fe2</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;match adjacent frames&quot;&quot;&quot;</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fe1</span><span class="o">.</span><span class="n">cells</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">sort_value</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="c1"># print(parent)</span>
            <span class="n">trees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_tree</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">match_single_cell</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">fe2</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracker.track_near_frame_mult_thread"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.track_near_frame_mult_thread">[docs]</a>    <span class="k">def</span> <span class="nf">track_near_frame_mult_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe1</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">,</span> <span class="n">fe2</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Match Adjacent Frames, Multithreaded Beta&quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">work</span><span class="p">(</span><span class="n">__parent</span><span class="p">:</span> <span class="n">Cell</span><span class="p">):</span>
            <span class="n">trees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_tree</span><span class="p">(</span><span class="n">__parent</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">match_single_cell</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">fe2</span><span class="p">)</span>

        <span class="n">thread_pool_executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">thread_name_prefix</span><span class="o">=</span><span class="s2">&quot;track_&quot;</span><span class="p">)</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fe1</span><span class="o">.</span><span class="n">cells</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">sort_value</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># print([i.sort_value for i in cells])</span>
        <span class="k">for</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="n">thread_pool_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
        <span class="n">thread_pool_executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracker.handle_duplicate_match"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.handle_duplicate_match">[docs]</a>    <span class="k">def</span> <span class="nf">handle_duplicate_match</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duplicate_match_cell</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve a cell is repeatedly matched by multiple cells&quot;&quot;&quot;</span>
        <span class="n">child_node</span> <span class="o">=</span> <span class="n">CellNode</span><span class="p">(</span><span class="n">duplicate_match_cell</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_tree</span><span class="p">(</span><span class="n">duplicate_match_cell</span><span class="p">)</span>
        <span class="n">parent0</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">child_node</span><span class="o">.</span><span class="n">nid</span><span class="p">)</span>

        <span class="n">parent1</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">child_node</span><span class="o">.</span><span class="n">nid</span><span class="p">)</span>
        <span class="c1"># if not (parent0.is_root() and parent1.is_root()):</span>
        <span class="c1">#     parent00 = tmp[0].parent(parent0.nid)</span>
        <span class="c1">#     parent11 = tmp[1].parent(parent1.nid)</span>
        <span class="c1">#     tree_dict = {parent00: tmp[0], parent11: tmp[1]}</span>
        <span class="c1">#     sm0 = self.matcher.match_similar(duplicate_match_cell, parent00.cell)</span>
        <span class="c1">#     sm1 = self.matcher.match_similar(duplicate_match_cell, parent11.cell)</span>
        <span class="c1">#     # match_score = {parent00: sm0[&#39;IoU&#39;] + 1 / (sm0[&#39;distance&#39;] + 1e-5),</span>
        <span class="c1">#     #                parent11: sm1[&#39;IoU&#39;] + 1 / (sm0[&#39;distance&#39;] + 1e-5), }</span>
        <span class="c1">#     match_score = {parent00: sm0[&#39;distance&#39;],</span>
        <span class="c1">#                    parent11: sm0[&#39;distance&#39;]}</span>
        <span class="c1">#     error_parent = max(match_score)</span>
        <span class="c1"># else:</span>
        <span class="n">tree_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">parent0</span><span class="p">:</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parent1</span><span class="p">:</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
        <span class="n">sm0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">duplicate_match_cell</span><span class="p">,</span> <span class="n">parent0</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="n">sm1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">duplicate_match_cell</span><span class="p">,</span> <span class="n">parent1</span><span class="o">.</span><span class="n">cell</span><span class="p">)</span>
        <span class="c1"># match_score = {parent0: sm0[&#39;IoU&#39;] + 1 / (sm0[&#39;distance&#39;] + 1e-5),</span>
        <span class="c1">#                parent1: sm1[&#39;IoU&#39;] + 1 / (sm0[&#39;distance&#39;] + 1e-5), }</span>
        <span class="n">match_score</span> <span class="o">=</span> <span class="p">{</span><span class="n">parent0</span><span class="p">:</span> <span class="n">sm0</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">],</span>
                       <span class="n">parent1</span><span class="p">:</span> <span class="n">sm1</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]}</span>
        <span class="c1"># truth_parent = max(match_score)</span>
        <span class="n">error_parent</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">match_score</span><span class="p">)</span>
        <span class="c1"># if len(tree_dict[truth_parent].nodes) &lt; 3:</span>
        <span class="c1">#     error_parent = truth_parent</span>
        <span class="n">tree_dict</span><span class="p">[</span><span class="n">error_parent</span><span class="p">]</span><span class="o">.</span><span class="n">remove_node</span><span class="p">(</span><span class="n">child_node</span><span class="o">.</span><span class="n">nid</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">error_parent</span><span class="p">:</span> <span class="n">tree_dict</span><span class="p">[</span><span class="n">error_parent</span><span class="p">]}</span></div>

<div class="viewcode-block" id="Tracker.rematch"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.rematch">[docs]</a>    <span class="k">def</span> <span class="nf">rematch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe1</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">,</span> <span class="n">fe2</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;For the loss detection cells, re-match the upper and lower frames with the cache frame&quot;&quot;&quot;</span>
        <span class="n">unmatched_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">fe1</span><span class="o">.</span><span class="n">cells</span> <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">is_be_matched</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unmatched_list</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="c1"># for cell in fe1.cells:</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">unmatched_list</span><span class="p">:</span>
            <span class="n">current_frame</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">frame</span>
            <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">is_be_matched</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">handle_flag</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">trees</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span>
                <span class="n">wait_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">wait_tree_map</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">trees</span><span class="p">:</span>
                    <span class="n">last_layer_cells</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">last_layer_cell</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">last_layer_cell</span> <span class="ow">in</span> <span class="n">last_layer_cells</span><span class="p">:</span>
                        <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">current_frame</span> <span class="o">-</span> <span class="n">last_layer_cell</span><span class="o">.</span><span class="n">frame</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                            <span class="n">match_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">last_layer_cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;IoU&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">cell</span><span class="o">.</span><span class="n">d_long</span><span class="p">:</span>
                                <span class="n">wait_dict</span><span class="p">[</span><span class="n">last_layer_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;IoU&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">/</span> <span class="p">(</span>
                                        <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>
                                <span class="n">wait_tree_map</span><span class="p">[</span><span class="n">last_layer_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span>
                                <span class="n">handle_flag</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">handle_flag</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">last_layer_cell</span> <span class="ow">in</span> <span class="n">last_layer_cells</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">GAP_WINDOW_LEN</span><span class="p">:</span>
                                <span class="k">if</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">current_frame</span> <span class="o">-</span> <span class="n">last_layer_cell</span><span class="o">.</span><span class="n">frame</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">GAP_WINDOW_LEN</span><span class="p">:</span>
                                    <span class="n">match_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">last_layer_cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                                        <span class="n">wait_dict</span><span class="p">[</span><span class="n">last_layer_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;IoU&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">/</span> <span class="p">(</span>
                                                <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>
                                        <span class="n">wait_tree_map</span><span class="p">[</span><span class="n">last_layer_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span>
                                        <span class="n">handle_flag</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">current_frame</span> <span class="o">&gt;</span> <span class="n">last_layer_cell</span><span class="o">.</span><span class="n">frame</span><span class="p">:</span>
                                    <span class="n">match_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">match_similar</span><span class="p">(</span><span class="n">last_layer_cell</span><span class="p">,</span> <span class="n">cell</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                                        <span class="n">wait_dict</span><span class="p">[</span><span class="n">last_layer_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;IoU&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">/</span> <span class="p">(</span>
                                                <span class="n">match_result</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-5</span><span class="p">)</span>
                                        <span class="n">wait_tree_map</span><span class="p">[</span><span class="n">last_layer_cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span>
                                        <span class="n">handle_flag</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">wait_dict</span><span class="p">:</span>
                    <span class="n">matched_cell</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wait_dict</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">wait_dict</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
                    <span class="n">tree</span> <span class="o">=</span> <span class="n">wait_tree_map</span><span class="p">[</span><span class="n">matched_cell</span><span class="p">]</span>
                    <span class="n">child_node</span> <span class="o">=</span> <span class="n">CellNode</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                    <span class="n">parent_node</span> <span class="o">=</span> <span class="n">CellNode</span><span class="p">(</span><span class="n">matched_cell</span><span class="p">)</span>
                    <span class="n">tree</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">child_node</span><span class="p">,</span> <span class="n">parent_node</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">is_accurate_matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">is_be_matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">set_match_status</span><span class="p">(</span><span class="s1">&#39;ACCURATE&#39;</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">set_track_id</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">set_branch_id</span><span class="p">(</span><span class="n">matched_cell</span><span class="o">.</span><span class="n">branch_id</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">match_single_cell</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">fe2</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">handle_flag</span><span class="p">:</span>
                    <span class="n">tree</span> <span class="o">=</span> <span class="n">TrackingTree</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id_distributor</span><span class="p">())</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">set_track_id</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">set_branch_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">set_cell_id</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">branch_id</span><span class="p">))</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">update_region</span><span class="p">(</span><span class="n">track_id</span><span class="o">=</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">update_region</span><span class="p">(</span><span class="n">branch_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">node</span> <span class="o">=</span> <span class="n">CellNode</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">set_branch_id</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">set_track_id</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;ACCURATE&#39;</span>
                    <span class="n">tree</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tree_maps</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span> <span class="o">=</span> <span class="n">tree</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">set_match_status</span><span class="p">(</span><span class="s1">&#39;ACCURATE&#39;</span><span class="p">)</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">CellStatus</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">is_accurate_matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">cell</span><span class="o">.</span><span class="n">is_be_matched</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">match_single_cell</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">fe2</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracker.check_track"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.check_track">[docs]</a>    <span class="k">def</span> <span class="nf">check_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe1</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">,</span> <span class="n">fe2</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">,</span> <span class="n">fe3</span><span class="p">:</span> <span class="n">FeatureExtractor</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check the track results to see if there are any wrong matches and omissions,</span>
<span class="sd">        and update the matching status at the same time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fe2</span><span class="o">.</span><span class="n">cells</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">cell</span><span class="o">.</span><span class="n">sort_value</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rematch</span><span class="p">(</span><span class="n">fe1</span><span class="p">,</span> <span class="n">fe2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_tree</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_duplicate_match</span><span class="p">(</span><span class="n">duplicate_match_cell</span><span class="o">=</span><span class="n">cell</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracker.track"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.track">[docs]</a>    <span class="k">def</span> <span class="nf">track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">speed_filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Read image frames sequentially and start tracking&quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">writer</span><span class="p">,</span> <span class="n">speed_f</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">speed_filename</span><span class="p">:</span>
            <span class="n">speed_f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">speed_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">speed_f</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="s1">&#39;Speed (it/s)&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">fe_before</span><span class="p">,</span> <span class="n">fe_current</span><span class="p">,</span> <span class="n">fe_next</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_ext</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">range</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;tracking process&#39;</span><span class="p">):</span>
            <span class="c1"># self.track_near_frame(fe_before, fe_current)</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">track_near_frame</span><span class="p">(</span><span class="n">fe_before</span><span class="p">,</span> <span class="n">fe_current</span><span class="p">)</span>
            <span class="c1"># self.track_near_frame_mult_thread(fe_before, fe_current)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fe_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fe_before</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_track</span><span class="p">(</span><span class="n">fe_before</span><span class="p">,</span> <span class="n">fe_current</span><span class="p">,</span> <span class="n">fe_next</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">fe_before</span>

            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">speed_filename</span><span class="p">:</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">end_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1e-10</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">range</span><span class="p">:</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="nb">range</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="n">speed_filename</span><span class="p">:</span>
            <span class="n">speed_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

        <span class="c1"># __filter_trees = [tree for tree in self.trees if len(tree.nodes) &gt; 10]</span>
        <span class="c1"># del self.trees</span>
        <span class="c1"># self.trees = __filter_trees</span>

<div class="viewcode-block" id="Tracker.track_tree_to_json"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.track_tree_to_json">[docs]</a>    <span class="k">def</span> <span class="nf">track_tree_to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="n">jsf</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;tree-</span><span class="si">{</span><span class="n">i</span><span class="o">.</span><span class="n">track_id</span><span class="si">}</span><span class="s1">.json&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">jsf</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">jsf</span><span class="p">)</span>
            <span class="n">i</span><span class="o">.</span><span class="n">save2file</span><span class="p">(</span><span class="n">jsf</span><span class="p">)</span></div>

<div class="viewcode-block" id="Tracker.visualize_single_tree"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.visualize_single_tree">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_single_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="n">background_filename_list</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">xrange</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">bg_fname</span> <span class="o">=</span> <span class="n">background_filename_list</span><span class="p">[:</span><span class="n">xrange</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">xrange</span> <span class="k">else</span> <span class="n">background_filename_list</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">bg_fname</span><span class="p">)</span>
        <span class="n">images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">bg_fname</span><span class="p">))</span>
        <span class="n">images_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bg_fname</span><span class="p">))),</span> <span class="n">images</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">images_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">expand_tree</span><span class="p">():</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">frame</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">bbox</span>
            <span class="n">img_bg</span> <span class="o">=</span> <span class="n">images_dict</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
            <span class="n">phase</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">phase</span>
            <span class="n">images_dict</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_bbox</span><span class="p">(</span><span class="n">img_bg</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">,</span>
                                                <span class="n">tree</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">branch_id</span><span class="p">,</span> <span class="n">phase</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bg_fname</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">images_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.tif&#39;</span><span class="p">,</span> <span class="s1">&#39;.png&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="Tracker.visualize_to_tif"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.Tracker.visualize_to_tif">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_to_tif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">background_mcy_image</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_tif_path</span><span class="p">,</span> <span class="n">tree_list</span><span class="p">,</span> <span class="n">xrange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">single</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize the tracking results, you can choose to save as a single tif file or multiple tif sequences</span>
<span class="sd">        :param background_mcy_image: background image for visualization</span>
<span class="sd">        :param output_tif_path: output file path</span>
<span class="sd">        :param tree_list: TrackingTree list to visualize</span>
<span class="sd">        :param xrange: visualization range</span>
<span class="sd">        :param single: Whether to choose to save as a single file</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">adjust_gamma</span><span class="p">(</span><span class="n">__image</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">convert_dtype</span><span class="p">(</span><span class="n">__image</span><span class="p">)</span>
            <span class="n">brighter_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">((</span><span class="n">image</span> <span class="o">/</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">gamma</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">brighter_image</span>

        <span class="n">tif</span> <span class="o">=</span> <span class="n">readTif</span><span class="p">(</span><span class="n">background_mcy_image</span><span class="p">)</span>
        <span class="n">images_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">xrange</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tif</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">xrange</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">adjust_gamma</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="n">images_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
                <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tif</span><span class="p">:</span>
                    <span class="n">images_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
                    <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tree_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">expand_tree</span><span class="p">():</span>
                <span class="n">frame</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">frame</span>
                <span class="k">if</span> <span class="n">xrange</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">frame</span> <span class="o">&gt;</span> <span class="n">xrange</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="c1"># bbox = i.nodes.get(node).cell.bbox</span>
                <span class="n">img_bg</span> <span class="o">=</span> <span class="n">images_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">img_bg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">images_dict</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw_bbox</span><span class="p">(</span><span class="n">img_bg</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">track_id</span><span class="p">,</span>
                                                        <span class="n">i</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">branch_id</span><span class="p">,</span>
                                                        <span class="n">phase</span><span class="o">=</span><span class="n">i</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span><span class="o">.</span><span class="n">phase</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">single</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">output_tif_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">output_tif_path</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">output_tif_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;save tracking visualization&quot;</span><span class="p">):</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_tif_path</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">output_tif_path</span><span class="p">)[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s1">0&gt;4d</span><span class="si">}</span><span class="s1">.tif&#39;</span><span class="p">)</span>
                <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">images_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">TiffWriter</span><span class="p">(</span><span class="n">output_tif_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">index</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">300</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                            <span class="s2">&quot;the image is to big to save, and the tifffile cannot save the size &gt;4GB tifffile, &quot;</span>
                            <span class="s2">&quot;so this image will be cut down.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="n">tif</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">images_dict</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="get_cell_line_from_tree"><a class="viewcode-back" href="../../python_apis/SCTrack.tracker.html#SCTrack.tracker.get_cell_line_from_tree">[docs]</a><span class="k">def</span> <span class="nf">get_cell_line_from_tree</span><span class="p">(</span><span class="n">tree</span><span class="p">:</span> <span class="n">TrackingTree</span><span class="p">,</span> <span class="n">dic_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mcy_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">savepath</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Obtain a complete cell sequence from the track tree, including cell images, dic and mcy dual channels, and cycles,</span>
<span class="sd">    and the generated file name is named track_id-branch_id-frame-phase.tif&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">savepath</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">savepath</span><span class="p">)</span>
    <span class="n">save_mcy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;mcy&#39;</span><span class="p">)</span>
    <span class="n">save_dic</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span> <span class="s1">&#39;dic&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_mcy</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_mcy</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_dic</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_dic</span><span class="p">)</span>
    <span class="n">mcy</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">mcy_path</span><span class="p">)</span>
    <span class="n">dic</span> <span class="o">=</span> <span class="n">tifffile</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">dic_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">nid</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">expand_tree</span><span class="p">():</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">get_node</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span><span class="o">.</span><span class="n">cell</span>
        <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">bbox</span>
        <span class="n">mcy_img</span> <span class="o">=</span> <span class="n">mcy</span><span class="p">[</span><span class="n">cell</span><span class="o">.</span><span class="n">frame</span><span class="p">][</span><span class="n">y0</span><span class="p">:</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="n">x1</span><span class="p">]</span>
        <span class="n">dic_img</span> <span class="o">=</span> <span class="n">dic</span><span class="p">[</span><span class="n">cell</span><span class="o">.</span><span class="n">frame</span><span class="p">][</span><span class="n">y0</span><span class="p">:</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x0</span><span class="p">:</span> <span class="n">x1</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">branch_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">phase</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;.tif&#39;</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_mcy</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">convert_dtype</span><span class="p">(</span><span class="n">mcy_img</span><span class="p">))</span>
        <span class="n">tifffile</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dic</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span> <span class="n">convert_dtype</span><span class="p">(</span><span class="n">dic_img</span><span class="p">))</span></div>

        <span class="c1"># break</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;G:\20x_dataset\evaluate_data\copy_of_1_xy19\result-GT.json&#39;</span>
    <span class="n">mcy_img</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;G:\20x_dataset\evaluate_data\copy_of_1_xy19\mcy.tif&#39;</span>
    <span class="n">dic_img</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;G:\20x_dataset\evaluate_data\copy_of_1_xy19\dic.tif&#39;</span>
    <span class="n">tracker</span> <span class="o">=</span> <span class="n">Tracker</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
    <span class="c1"># tracker = Tracker(r&#39;G:\20x_dataset\evaluate_data\copy_of_1_xy19\result-GT.json&#39;)</span>
    <span class="n">tracker</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tracker</span><span class="o">.</span><span class="n">trees</span><span class="p">):</span>
        <span class="n">get_cell_line_from_tree</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dic_img</span><span class="p">,</span> <span class="n">mcy_img</span><span class="p">,</span>
                                <span class="sa">fr</span><span class="s1">&#39;G:\20x_dataset\evaluate_data\copy_of_1_xy19\cell_lines\</span><span class="si">{</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Li Chengxin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>